---
layout: default
author: muyalei
title: ambari安装
date: 2019-11-11
tags:
    - 大数据相关
---
 
**参考：** [https://www.cnblogs.com/dajianshi/p/9455980.html](https://www.cnblogs.com/dajianshi/p/9455980.html)、[https://blog.csdn.net/create_17/article/details/83692585](https://blog.csdn.net/create_17/article/details/83692585)

# 安装前环境搭建

## 一、配置说明

### 1、硬件环境
```
节点类型	操作系统	     ip地址	               主机名	           说明
主节点	    Centos-7	  192.168.74.3	     master.ambari.com	     内存：4G+
从节点	    Centos-7	  192.168.74.4	     slave1.ambari.com	     内存：2G+
从节点	    Centos-7	  192.168.74.5	     slave2.ambari.com	     内存：2G+
```

### 2. 软件环境
```
软件名称	     版本号
JDK	          jdk1.8.0_162
Mysql	      5.7.23
Ambari	      2.7.0
HDP	          3.0.0
```

## 二、修改主机名和hosts文件

### 1. 修改主机名（三台主机都执行）
```
vim /etc/hostname   #该命令需要重启后生效
#还有另外一种方式，执行该命令后立即生效，只不过需要重启Xshell连接
hostnamectl set-hostname master
```

### 2. 修改hosts文件（三台主机都设置）

```
vim /etc/hosts
#在文件末尾添加下列行（必须写上FQDN，后续通过web页面配置集群会用到）
192.168.74.3 master.ambari.com master
192.168.74.4 slave1.ambari.com slave1
192.168.74.5 slave2.ambari.com slave2
```

## 三、关闭防火墙和selinux

### 1. 防火墙设置
```
# 查看防火墙状态
systemctl status firewalld
# 查看开机是否启动防火墙服务
systemctl is-enabled firewalld
# 关闭防火墙
systemctl stop firewalld
systemctl disable firewalld
# 再次查看防火墙状态和开机防火墙是否启动
systemctl status firewalld
systemctl is-enabled firewalld
```

### 2. 禁用selinux
```
# 永久性关闭selinux（重启服务器生效）
sed -i 's/SELINUX=enforcing/SELINUX =disabled/' /etc/selinux/config
# 临时关闭selinux（立即生效，重启服务器失效）
setenforce 0
# 查看selinux状态
getenforce
# disabled为永久关闭，permissive为临时关闭，enforcing为开启
```

## 四、免密登陆

**注意：要实现免密登录，必须安装openssh服务**

```
yum install openssh-server openssh-client -y
#安装后，修改sshd_config配置
vim /etc/ssh/sshd_config
#在文件中设置如下属性：（按 / 可以进入搜索模式，按esc退出搜索模式）
PubkeyAuthentication yes
PermitRootLogin yes
#重启ssh服务
systemctl restart sshd
```

各个主机均执行以下操作：
```
## 生成密钥对
ssh-keygen -t rsa   ## 一路回车即可
## 进入.ssh目录，如果目录不存在则创建
cd ~/.ssh #如果.ssh目录不存在，执行一次'ssh localhost'即可
## 将公钥导入至authorized_keys
cat id_rsa.pub >> authorized_keys
## 修改文件权限
chmod 700 ~/.ssh
chmod 600 authorized_keys
```

在master.ambari.com上执行：
```
## 配置主从互相免密登陆
[root@node1 ~]# cat ~/.ssh/id_rsa.pub | ssh root@slave1.ambari.com 'cat - >> ~/.ssh/authorized_keys'
[root@node1 ~]# cat ~/.ssh/id_rsa.pub | ssh root@slave2.ambari.com 'cat - >> ~/.ssh/authorized_keys'
ssh slave1.ambari.com 
ssh slave2.ambari.com # 验证主机点是否可以免密登陆从节点，执行exit命令退出即可。
```

## 五、安装JDK

Java环境推荐使用 Oracle 的 JDK，首先，准备好文件 [jdk-8u162-linux-x64.tar.gz](链接:https://pan.baidu.com/s/1jPbN3DjIzV0Ln3UFS9a1tw)(密码:q67c)，然后将文件移到/usr/local目录下：
```
mv jdk-8u162-linux-x64.tar.gz /usr/local
```
解压文件
```
tar -zxvf jdk-8u162-linux-x64.tar.gz
```
重命名文件夹为java
```
mv jdk-1.8.0_162 java
```
用vim打开/etc/profile文件（Linux下配置系统环境变量的文件）
```
vim /etc/profile
```
按i进入编辑模式，在文件末尾添加如下JAVA环境变量
```
export JAVA_HOME=/usr/local/java
export JRE_HOME=/usr/local/java/jre
#下面两个变量，不设置也可以
export CLASSPATH=.:$CLASSPATH:$JAVA_HOME/lib:$JRE_HOME/lib
export PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin
```
最后，需要让该环境变量生效，执行如下代码：
```
source /etc/profile
```
检验JAVA是否安装成功
```
echo $JAVA_HOME     # 检验变量值
java -version
java
javac
```
如果设置正确的话，java -version 会输出 java 的版本信息，java 和 javac 会输出命令的使用指导。


##六、安装mariadb

**参考[https://github.com/muyalei/muyalei.github.io/blob/gh-pages/_posts/mysql%E7%9B%B8%E5%85%B3/2016-09-29-centos7%20mysql%E5%AE%89%E8%A3%85%E3%80%81%E9%85%8D%E7%BD%AE.md](https://github.com/muyalei/muyalei.github.io/blob/gh-pages/_posts/mysql%E7%9B%B8%E5%85%B3/2016-09-29-centos7%20mysql%E5%AE%89%E8%A3%85%E3%80%81%E9%85%8D%E7%BD%AE.md)**

#安装mariadb
```
yum install mariadb-server mariadb
```
#将mariadb加入开机启动项
```
systemctl enable mariadb
```
#启动mariadb
```
systemctl start mariadb
```
#设置root账号密码
```
mysql -uroot -ptoor #初次登录，没有密码，直接按回车进入
set password for 'root'@'localhost' =password('密码');
```
#允许远程连接mariadb
```
grant all privileges on *.* to root@'%'identified by '密码';
```
#创建ambari账号
```
CREATE USER 'ambari'@'%' IDENTIFIED BY 'ambari';
GRANT ALL PRIVILEGES ON *.* TO 'ambari'@'%';
CREATE USER 'ambari'@'localhost' IDENTIFIED BY 'ambari';
GRANT ALL PRIVILEGES ON *.* TO 'ambari'@'localhost';
CREATE USER 'ambari'@'master.ambari.com' IDENTIFIED BY 'ambari';
GRANT ALL PRIVILEGES ON *.* TO 'ambari'@'master.ambari.com';  //本地主机名
FLUSH PRIVILEGES;
```
#使用ambari用户登陆并创建数据库
```
mysql -uambari -pambari
CREATE DATABASE ambari;
exit;
```

## 七、安装配置NTP服务，保证集群时间保持同步

### 1、所有节点上使用yum安装配置NTP服务
```
yum install ntp -y
```

### 2、选定一台节点作为NTP server, 192.168.74.3

修改/etc/ntp.conf
```
vim  /etc/ntp.conf
```
（1）注释掉restrict 127.0.0.1 ，修改为：
```
restrict 192.168.74.3 mask 255.255.0.0 nomodify notrap
```
（2）使本地时钟可作为时钟源，添加如下两行：
```
server 127.127.1.0
fudge 127.127.1.0 stratum 10
```
（3）屏蔽默认服务器设置，添加国内节点
```
#server in China
server 202.112.10.36 prefer
server 1.cn.pool.ntp.org
server 2.cn.pool.ntp.org
server 3.cn.pool.ntp.org
server 0.cn.pool.ntp.org
```

（4）启用ntpd服务

设置ntpd为自启动
```
systemctl enable ntpd
```
启动ntpd服务
```
systemctl start ntpd
```

### 3、配置其他节点作为客户端（每个节点都执行）

（1）修改/etc/ntp.conf

添加主节点，屏蔽默认服务器设置：
```
server  192.168.74.3
```
保存退出，复制到其他客户端节点或者在每个节点执行上述编辑。

例如在slave1上编辑完成后，从slave1通过scp复制到其他主机：
```
scp /etc/ntp.conf slave2:/etc/.
```
（2）【每个节点】执行：

从主节点同步时间：
```
ntpdate ep-bd01
```
设置自动启动，然后启动ntpd
```
systemctl enable ntpd
systemctl start ntpd
```

### 4、注意事项

（1）当server与client之间的时间误差过大时（可能是1000秒），处于对修改时间可能对系统和应用带来不可预知的问题，NTP将停止时间同步！
所以如果发现NTP启动之后时间并不进行同步时，应该考虑到可能是时间差过大引起的，此时需要先手动进行时间同步！

手动同步命令
```
ntpdate  ep-bd01
```
（2）the NTP socket is in use, exiting“”【错误解决】 

the NTP socket is in use, exiting的解决办法</p>
the NTP socket is in use, exiting</p>
这个错误的原因是存在已经启动的ntpdate服务，重复启动导致的。</p>
使用下面的命令查看进程：“lsof -i:123” 这里的123是端口号，例如我的机器运行结果是：</p>
```
[root@ep-bd03]# lsof -i:123
```
命令输出如下：
```
COMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAME

ntpd 30016 ntp 16u IPv4 389632 0t0 UDP *:ntp 
ntpd 30016 ntp 17u IPv6 389633 0t0 UDP *:ntp 
ntpd 30016 ntp 18u IPv4 389638 0t0 UDP localhost:ntp 
ntpd 30016 ntp 19u IPv4 389639 0t0 UDP ep-bd03:ntp 
ntpd 30016 ntp 20u IPv4 389640 0t0 UDP ep-bd03:ntp 
ntpd 30016 ntp 21u IPv6 389641 0t0 UDP localhost:ntp 
ntpd 30016 ntp 22u IPv6 389642 0t0 UDP ep-bd03:ntp
```
杀kill掉这个进程后，重新运行ntpdate 校时服务
```
[root@ep-bd03 ]# kil -9 30016
```



















































