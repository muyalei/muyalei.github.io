---
layout: default
author: muyalei
title: ambari安装
date: 2019-11-11
tags:
    - 大数据相关
---
 
**参考：** 

[https://www.cnblogs.com/dajianshi/p/9455980.html](https://www.cnblogs.com/dajianshi/p/9455980.html)

[https://blog.csdn.net/create_17/article/details/83692585](https://blog.csdn.net/create_17/article/details/83692585)
 
[https://hadronw.com/2018/03-25/CentOS-7-%E5%AE%89%E8%A3%85Ambari-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/](https://hadronw.com/2018/03-25/CentOS-7-%E5%AE%89%E8%A3%85Ambari-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/)

[https://blog.51cto.com/hsbxxl/1981411](https://blog.51cto.com/hsbxxl/1981411)

## 配置说明

### 1、硬件环境

| 节点类型 | 操作系统 | ip地址 | 主机名 | 说明 |
| :------: | :------: | :------: | :------: | :------: | 
| 主节点 | Centos-7 | 192.168.74.3 | master.ambari.com | 内存：4G |
| 从节点 | Centos-7 | 192.168.74.4 | slave1.ambari.com | 内存：2G |
| 从节点 | Centos-7 | 192.168.74.5 | slave2.ambari.com | 内存：2G |


### 2. 软件环境

| 软件名称 | 版本号 |
| :------: | :------: |
| JDK | jdk1.8.0_162 |
| Mariadb | 5.5.64 |
| Ambari | 2.7.0 |
| HDP | 3.0.0 |


## 一、环境配置，安装必备软件（所有主机都设置）

### 1、安装yum priorities plugin
```
yum install yum-plugin-priorities -y
```

### 2、设置系统运行参数：

（1）设置swappiness
```
echo 10 > /proc/sys/vm/swappiness
```
（2） 禁用 透明大页面压缩
运行时设置：
```
echo never > /sys/kernel/mm/transparent_hugepage/defrag
echo never > /sys/kernel/mm/transparent_hugepage/enabled
```
同样添加上面2行到/etc/rc.local以便重启是运行

*【注意，为使/etc/rc.local开机可以运行，必须给/etc/rc.d/rc.local添加执行权限】*
```
chmod +x /etc/rc.d/rc.local
```

### 3、HAWQ2.30所需系统环境设置【全部主机节点】：

（1）vim /etc/sysctl.conf,编辑如下内容:
```
kernel.shmmax= 1000000000
kernel.shmmni= 4096
kernel.shmall= 4000000000
kernel.sem= 250 512000 100 2048
kernel.sysrq= 1
kernel.core_uses_pid= 1
kernel.msgmnb= 65536
kernel.msgmax= 65536
kernel.msgmni= 2048
net.ipv4.tcp_syncookies= 0
net.ipv4.ip_forward= 0
net.ipv4.conf.default.accept_source_route= 0
net.ipv4.tcp_tw_recycle= 1
net.ipv4.tcp_max_syn_backlog= 200000
net.ipv4.conf.all.arp_filter= 1
net.ipv4.ip_local_port_range= 1281 65535
net.core.netdev_max_backlog= 200000
#java程序多时，设成2会导致很多服务不能去启动！
#vm.overcommit_memory= 2  
vm.overcommit_memory=0
fs.nr_open= 3000000
kernel.threads-max= 798720
kernel.pid_max= 798720
#increase network
net.core.rmem_max=2097152
net.core.wmem_max=2097152
```
保存退出后，使用命令“sysctl -p” 使之生效：
```
sysctl -p
```
（2）修改/etc/security/limits.conf，设置打开文件数限制：
```
vim /etc/security/limits.conf
```
编辑如下内容:
```
* soft nofile 2900000
* hard nofile 2900000
* soft nproc 131072
* hard nproc 131072
```
*注：*像上面这样设置打开文件数限制后，可能导致操作系统开机后登录不进去，参考：[2019-11-27-centos7进入安全模式.md](https://github.com/muyalei/muyalei.github.io/blob/gh-pages/_posts/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3/linux%E7%9B%B8%E5%85%B3/2019-11-27-centos7%E8%BF%9B%E5%85%A5%E5%AE%89%E5%85%A8%E6%A8%A1%E5%BC%8F.md)，进入安全模式删掉上面的设置后重启，即可登录系统。

重新登录以使配置生效，或者使用命令临时设置一下：
```
ulimit -n 10240
```
*注：*ulimit -n 10240 ，这个命令必须执行，否则安装hdfs时可能报错：Error: Error: Unable to run the custom hook script ['/usr/bin/python', '/var/lib/ambari-agent/cache/stack-hooks/before-ANY/scripts/hook.py', 'ANY', '/var/lib/ambari-agent/data/command-303.json', '/var/lib/ambari-agent/cache/stack-hooks/before-ANY', '/var/lib/ambari-agent/data/structured-out-303.json', 'INFO', '/var/lib/ambari-agent/tmp', 'PROTOCOL_TLSv1_2', ''] 
### 4、准备HAWQ2.3.0依赖软件包

（1）hawq2.3.0所需必备软件包如下：
```
libgsasl is needed by apache-hawq-2.3.0.0-el7.x86_64
protobuf >= 2.5.0 is needed by apache-hawq-2.3.0.0-el7.x86_64
net-snmp-libs is needed by apache-hawq-2.3.0.0-el7.x86_64
thrift >= 0.9.1 is needed by apache-hawq-2.3.0.0-el7.x86_64
boost >= 1.53.0 is needed by apache-hawq-2.3.0.0-el7.x86_64
其中gcc gcc-c++ protobuf net-snmp-libs boots可直接安装。而安装libgsasl需要添加一个包含libgsasl库的源。
```

（2）新建/etc/yum.repos.d/fedora.repo文件，添加如下内容： 
```
[epel-repo]
name=epel
baseurl=http://dl.fedoraproject.org/pub/epel/6/x86_64/
enabled=1
gpgcheck=0
```

（3）安装各个软件包：
```
yum install gcc gcc-c++ -y
yum install protobuf -y
yum install net-snmp-libs -y
yum install boost -y 
yum install libgsasl-devel -y
yum install libevent -y
```

（4）thrift 0.9.1需要下载安装包并使用rpm进行安装
```
wget http://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/t/thrift-0.9.1-15.el7.x86_64.rpm
rpm -ivh thrift-0.9.1-15.el7.x86_64.rpm
```


## 二、修改主机名和hosts文件

### 1. 修改主机名（三台主机都执行）
```
vim /etc/hostname   #该命令需要重启后生效
#还有另外一种方式，执行该命令后立即生效，只不过需要重启Xshell连接
hostnamectl set-hostname master
```

### 2. 修改hosts文件（三台主机都设置）

```
vim /etc/hosts
#在文件末尾添加下列行（必须写上FQDN，后续通过web页面配置集群会用到）
192.168.74.3 master.ambari.com master
192.168.74.4 slave1.ambari.com slave1
192.168.74.5 slave2.ambari.com slave2
```

## 三、关闭防火墙和selinux

### 1. 防火墙设置
```
# 查看防火墙状态
systemctl status firewalld
# 查看开机是否启动防火墙服务
systemctl is-enabled firewalld
# 关闭防火墙
systemctl stop firewalld
systemctl disable firewalld
# 再次查看防火墙状态和开机防火墙是否启动
systemctl status firewalld
systemctl is-enabled firewalld
```

### 2. 禁用selinux
```
# 永久性关闭selinux（重启服务器生效）
sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
# 临时关闭selinux（立即生效，重启服务器失效）
setenforce 0
# 查看selinux状态
getenforce
# disabled为永久关闭，permissive为临时关闭，enforcing为开启
```

## 四、免密登陆

**注意：要实现免密登录，必须安装openssh服务**

```
yum install openssh-server openssh-client -y
#安装后，修改sshd_config配置
vim /etc/ssh/sshd_config
#在文件中设置如下属性：（按 / 可以进入搜索模式，按esc退出搜索模式）
PubkeyAuthentication yes
PermitRootLogin yes
#重启ssh服务
systemctl restart sshd
```

各个主机均执行以下操作：
```
## 生成密钥对
ssh-keygen -t rsa   ## 一路回车即可
## 进入.ssh目录，如果目录不存在则创建
cd ~/.ssh #如果.ssh目录不存在，执行一次'ssh localhost'即可
## 将公钥导入至authorized_keys
cat id_rsa.pub >> authorized_keys
## 修改文件权限
chmod 700 ~/.ssh
chmod 600 authorized_keys
```

在master.ambari.com上执行：
```
## 配置主从互相免密登陆
[root@node1 ~]# cat ~/.ssh/id_rsa.pub | ssh root@slave1.ambari.com 'cat - >> ~/.ssh/authorized_keys'
[root@node1 ~]# cat ~/.ssh/id_rsa.pub | ssh root@slave2.ambari.com 'cat - >> ~/.ssh/authorized_keys'
ssh slave1.ambari.com 
ssh slave2.ambari.com # 验证主机点是否可以免密登陆从节点，执行exit命令退出即可。
```

## 五、安装JDK

Java环境推荐使用 Oracle 的 JDK，首先，准备好文件 [jdk-8u162-linux-x64.tar.gz](https://pan.baidu.com/s/1jPbN3DjIzV0Ln3UFS9a1tw)(密码:q67c)，然后将文件移到/usr/local目录下：
```
mv jdk-8u162-linux-x64.tar.gz /usr/local
#解压文件
tar -zxvf jdk-8u162-linux-x64.tar.gz
#重命名文件夹为java
mv jdk-1.8.0_162 java
#用vim打开/etc/profile文件（Linux下配置系统环境变量的文件）
vim /etc/profile
#按i进入编辑模式，在文件末尾添加如下JAVA环境变量
export JAVA_HOME=/usr/local/java
export JRE_HOME=/usr/local/java/jre
export CLASSPATH=.:$CLASSPATH:$JAVA_HOME/lib:$JRE_HOME/lib 
export PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin 
#最后，需要让该环境变量生效，执行如下代码：
source /etc/profile
#检验JAVA是否安装成功
echo $JAVA_HOME     # 检验变量值
java -version
java
javac
```
如果设置正确的话，java -version 会输出 java 的版本信息，java 和 javac 会输出命令的使用指导。



## 六、安装mariadb

**参考[https://github.com/muyalei/muyalei.github.io/blob/gh-pages/_posts/mysql%E7%9B%B8%E5%85%B3/2016-09-29-centos7%20mysql%E5%AE%89%E8%A3%85%E3%80%81%E9%85%8D%E7%BD%AE.md](https://github.com/muyalei/muyalei.github.io/blob/gh-pages/_posts/mysql%E7%9B%B8%E5%85%B3/2016-09-29-centos7%20mysql%E5%AE%89%E8%A3%85%E3%80%81%E9%85%8D%E7%BD%AE.md)**
```
#安装mariadb
yum install mariadb-server mariadb
#将mariadb加入开机启动项
systemctl enable mariadb
#启动mariadb
systemctl start mariadb
#设置root账号密码
mysql -uroot -ptoor #初次登录，没有密码，直接按回车进入
set password for 'root'@'localhost' =password('密码');
#允许远程连接mariadb
grant all privileges on *.* to root@'%'identified by '密码';
#创建ambari账号
CREATE USER 'ambari'@'%' IDENTIFIED BY 'ambari';
GRANT ALL PRIVILEGES ON *.* TO 'ambari'@'%';
CREATE USER 'ambari'@'localhost' IDENTIFIED BY 'ambari';
GRANT ALL PRIVILEGES ON *.* TO 'ambari'@'localhost';
CREATE USER 'ambari'@'master.ambari.com' IDENTIFIED BY 'ambari';
GRANT ALL PRIVILEGES ON *.* TO 'ambari'@'master.ambari.com';  //本地主机名
FLUSH PRIVILEGES;
#使用ambari用户登陆并创建数据库
mysql -uambari -pambari
CREATE DATABASE ambari;
exit;
```
*注：*反复重装环境的时候，可能会遇到错误：`mysql报错 ERROR 1133 (42000): Can't find any matching row in the user table`，解决办法参考[]()

如果要安装hive，参照上面的方式创建`hive`用户，创建数据库`hive`

### 安装jdbc驱动

```
yum install mysql-connector-java.jar 
```
或者
```
wget https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-5.1.46.tar.gz
tar zxvf mysql-connector-java-5.1.46.tar.gz
cd mysql-connector-java-5.1.46/
cp mysql-connector-java-5.1.46-bin.jar /usr/share/java/mysql-connector-java.jar
```
*注：*一定要将mysql-connector-java-5.1.46-bin.jar复制到/usr/share/java/mysql-connector-java.jar。


## 七、安装配置NTP服务，保证集群时间保持同步

*整理自[https://www.cnblogs.com/dajianshi/p/9473951.html](https://www.cnblogs.com/dajianshi/p/9473951.html)*

### 1、所有节点上使用yum安装配置NTP服务
```
yum install ntp -y
```

### 2、选定一台节点作为NTP server, 192.168.74.3

修改/etc/ntp.conf
```
vim  /etc/ntp.conf
```
（1）注释掉restrict 127.0.0.1 ，修改为：
```
restrict 192.168.74.3 mask 255.255.0.0 nomodify notrap
```
（2）使本地时钟可作为时钟源，添加如下两行：
```
server 127.127.1.0
fudge 127.127.1.0 stratum 10
```
（3）屏蔽默认服务器设置，添加国内节点
```
#server in China
server 202.112.10.36 prefer
server 1.cn.pool.ntp.org
server 2.cn.pool.ntp.org
server 3.cn.pool.ntp.org
server 0.cn.pool.ntp.org
```

（4）启用ntpd服务

设置ntpd为自启动
```
systemctl enable ntpd
```
启动ntpd服务
```
systemctl start ntpd
```

### 3、配置其他节点作为客户端（每个节点都执行）

（1）修改/etc/ntp.conf

添加主节点，屏蔽默认服务器设置：
```
server  192.168.74.3
```
保存退出，复制到其他客户端节点或者在每个节点执行上述编辑。

例如在slave1上编辑完成后，从slave1通过scp复制到其他主机：
```
scp /etc/ntp.conf slave2:/etc/.
```
（2）【每个节点】执行：

从主节点同步时间：
```
ntpdate ep-bd01
```
设置自动启动，然后启动ntpd
```
systemctl enable ntpd
systemctl start ntpd
```

### 4、注意事项

（1）当server与client之间的时间误差过大时（可能是1000秒），处于对修改时间可能对系统和应用带来不可预知的问题，NTP将停止时间同步！
所以如果发现NTP启动之后时间并不进行同步时，应该考虑到可能是时间差过大引起的，此时需要先手动进行时间同步！

手动同步命令
```
ntpdate  ep-bd01
```
（2）the NTP socket is in use, exiting“”【错误解决】 

the NTP socket is in use, exiting的解决办法</p>
the NTP socket is in use, exiting</p>
这个错误的原因是存在已经启动的ntpdate服务，重复启动导致的。</p>
使用下面的命令查看进程：“lsof -i:123” 这里的123是端口号，例如我的机器运行结果是：</p>
```
[root@ep-bd03]# lsof -i:123
```
命令输出如下：
```
COMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAME

ntpd 30016 ntp 16u IPv4 389632 0t0 UDP *:ntp 
ntpd 30016 ntp 17u IPv6 389633 0t0 UDP *:ntp 
ntpd 30016 ntp 18u IPv4 389638 0t0 UDP localhost:ntp 
ntpd 30016 ntp 19u IPv4 389639 0t0 UDP ep-bd03:ntp 
ntpd 30016 ntp 20u IPv4 389640 0t0 UDP ep-bd03:ntp 
ntpd 30016 ntp 21u IPv6 389641 0t0 UDP localhost:ntp 
ntpd 30016 ntp 22u IPv6 389642 0t0 UDP ep-bd03:ntp
```
杀kill掉这个进程后，重新运行ntpdate 校时服务
```
[root@ep-bd03 ]# kil -9 30016
```

# 安装ambari-server

## 一、搭建本地仓库：

### 1、下载软件包：

```
cd /root
mkdir downloads
cd downloads
wget http://public-repo-1.hortonworks.com/HDP-GPL/centos7/3.x/updates/3.0.0.0/HDP-GPL-3.0.0.0-centos7-gpl.tar.gz
wget http://public-repo-1.hortonworks.com/HDP/centos7/3.x/updates/3.0.0.0/hdp.repo
wget http://public-repo-1.hortonworks.com/HDP/centos7/3.x/updates/3.0.0.0/HDP-3.0.0.0-1634.xml
wget http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.7.0.0/ambari.repo
wget http://public-repo-1.hortonworks.com/HDP-UTILS-1.1.0.22/repos/centos7/HDP-UTILS-1.1.0.22-centos7.tar.gz
wget http://public-repo-1.hortonworks.com/HDP/centos7/3.x/updates/3.0.0.0/HDP-3.0.0.0-centos7-rpm.tar.gz
wget http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.7.0.0/ambari-2.7.0.0-centos7.tar.gz
```
 
### 2、搭建本地仓库：

安装并开启Apache HTTP服务
```
yum install httpd -y
systemctl enable httpd
systemctl start httpd 
```
确保/var/www/html目录存在，没有的话创建。
```
mkdir -p /var/www/html
```
创建HDP，HDF子目录
```
cd /var/www/html
mkdir hdp  hdf
```
解开下载的软件包：
```
cd /var/www/html
tar -zxvf  /root/downloads/ambari-2.7.0.0-centos7.tar.gz    -C .
tar -zxvf  /root/downloads/HDP-3.0.0.0-centos7-rpm.tar.gz   -C ./hdp
tar -zxvf  /root/downloads/HDP-GPL-3.0.0.0-centos7-gpl.tar.gz  -C ./hdp
tar -zxvf  /root/downloads/HDP-UTILS-1.1.0.22-centos7.tar.gz   -C ./hdp
```
修改下载的ambari.repo，
```
vim ambari.repo
```
安装如下内容修改，[注意版本号，需要根据具体下载的版本不同修改，解压后自己查看一下]：
```
#VERSION_NUMBER=2.7.0.0-897
[ambari-2.7.0.0]
#json.url = http://public-repo-1.hortonworks.com/HDP/hdp_urlinfo.json
name=ambari Version - ambari-2.7.0.0
baseurl=http://ep-bd01/ambari/centos7/2.7.0.0-897
gpgcheck=1
gpgkey=http://ep-bd01/ambari/centos7/2.7.0.0-897/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins
enabled=1
priority=1
```
复制到/etc/yum.repos.d
```
cp ambari.repo   /etc/yum.repos.d/ambari.repo
```

修改下载的hdp.repo，
```
vim hdp.repo
```
安装如下内容修改，[注意版本号，需要根据具体下载的版本不同修改，解压后自己查看一下]：
```
#VERSION_NUMBER=3.0.0.0-1634
[HDP-3.0]
name=HDP Version - HDP-3.0.0.0
baseurl=http://ep-bd01/hdp/HDP/centos7/3.0.0.0-1634
gpgcheck=1
gpgkey=http://ep-bd01/hdp/HDP/centos7/3.0.0.0-1634/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins
enabled=1
priority=1

[HDP-3.0-GPL]
name=HDP GPL Version - HDP-GPL-3.0.0.0
baseurl=http://ep-bd01/hdp/HDP-GPL/centos7/3.0.0.0-1634
gpgcheck=1
gpgkey=http://ep-bd01/hdp/HDP-GPL/centos7/3.0.0.0-1634/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins
enabled=1
priority=1

[HDP-UTILS-1.1.0.22]
name=HDP-UTILS Version - HDP-UTILS-1.1.0.22
baseurl=http://ep-bd01/hdp/HDP-UTILS/centos7/1.1.0.22
gpgcheck=1
gpgkey=http://ep-bd01/hdp/HDP-UTILS/centos7/1.1.0.22/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins
enabled=1
priority=1
```
保存退出，复制到/etc/yum.repos.d/
```
cp  hdp.repo  /etc/yum.repos.d/hdp.repo
```
 
## 二、主节点安装ambari server

### 1、使用刚才配置好的本地仓库，直接yum命令安装。
```
yum install ambari-server -y
```
### 2、查看ambari server 状态
```
 systemctl status ambari-server 

● ambari-server.service - LSB: ambari-server daemon
   Loaded: loaded (/etc/rc.d/init.d/ambari-server; bad; vendor preset: disabled)
   Active: inactive (dead)
     Docs: man:systemd-sysv-generator(8)
```
看到ambari server已成功安装了。

### 3、配置mariadb，建立用户和数据库供ambari使用

建立数据库用户ambari

```
mysql -uroot -p
MariaDB [(none)]> use mysql;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MariaDB [mysql]> grant all privileges on *.* to 'ambari'@'%' identified by 'ambari';
Query OK, 0 rows affected (0.06 sec)

MariaDB [mysql]> flush privileges;
Query OK, 0 rows affected (0.00 sec)

MariaDB [mysql]>
```
建立数据库ambari，并运行ambari数据库建表sql命令文件。

```
MariaDB [mysql]> create database ambari;
Query OK, 1 row affected (0.01 sec)

MariaDB [mysql]> use ambari;
Database changed
MariaDB [ambari]> source /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql;
Query OK, 0 rows affected (0.01 sec)

Query OK, 0 rows affected (0.00 sec)

Query OK, 0 rows affected (0.00 sec)

Query OK, 0 rows affected (0.06 sec)

Query OK, 0 rows affected (0.00 sec)
Statement prepared
... ...
```
### 4、配置ambari server

执行命令
```
ambari-server setup
```
回答选择项，其中JDK选择“”Custom“”，给出系统安装目录，数据库一定要选择高级配置，指定mariadb数据库和用户，本人系统中详细过程如下：

```
[root@ep-bd01 downloads]# ambari-server setup #ambari-server安装完成后，配置ambari-server
Using python  /usr/bin/python
Setup ambari-server
Checking SELinux...
SELinux status is 'disabled'
Customize user account for ambari-server daemon [y/n] (n)? n
Adjusting ambari-server permissions and ownership...
Checking firewall status...
Checking JDK...
[1] Oracle JDK 1.8 + Java Cryptography Extension (JCE) Policy Files 8
[2] Custom JDK #因为已经安装过jdk，这里选择`2`，手工添加jdk路径，可以通过`echo $JAVA_HOME`查看jdk路径，这里的路径是/usr/java/jdk1.8.0_181-amd64 
==============================================================================
Enter choice (1): 2
WARNING: JDK must be installed on all hosts and JAVA_HOME must be valid on all hosts.
WARNING: JCE Policy files are required for configuring Kerberos security. If you plan to use Kerberos,please make sure JCE Unlimited Strength Jurisdiction Policy Files are valid on all hosts.
Path to JAVA_HOME: /usr/java/jdk1.8.0_181-amd64
Validating JDK on Ambari Server...done.
Check JDK version for Ambari Server...
JDK version found: 8
Minimum JDK version is 8 for Ambari. Skipping to setup different JDK for Ambari Server.
Checking GPL software agreement...
GPL License for LZO: https://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html
Enable Ambari Server to download and install GPL Licensed LZO packages [y/n] (n)? n
Completing setup...
Configuring database...
Enter advanced database configuration [y/n] (n)? y  #选择数据库，我安装的是mariadb，所以这里选择`3`，这里注意，一定要在数据库中添加ambari用户、创建库ambari
Configuring database...
==============================================================================
Choose one of the following options:
[1] - PostgreSQL (Embedded)
[2] - Oracle
[3] - MySQL / MariaDB
[4] - PostgreSQL
[5] - Microsoft SQL Server (Tech Preview)
[6] - SQL Anywhere
[7] - BDB
==============================================================================
Enter choice (1): 3
Hostname (localhost): #如果mariadb安装在与ambari-server同一台服务器上，这里可以直接回车使用默认设置 
Port (3306):  #使用默认，回车
Database name (ambari): #默认，回车 
Username (ambari):  #默认，回车
Enter Database Password (bigdata): #这里要注意，这里要写上mariadb中ambari用户的密码，我设置的是`ambari`，这里就写上`ambari`
Re-enter password: #确认密码
Configuring ambari database...
Should ambari use existing default jdbc /usr/share/java/mysql-connector-java.jar [y/n] (y)? y
Configuring remote database connection properties...
WARNING: Before starting Ambari Server, you must run the following DDL against the database to create the schema: /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql
Proceed with configuring remote database connection properties [y/n] (y)? y
Extracting system views...
ambari-admin-2.7.0.0.897.jar
....
Ambari repo file doesn't contain latest json url, skipping repoinfos modification
Adjusting ambari-server permissions and ownership...
Ambari Server 'setup' completed successfully.
```

### 5、初始化数据库ambari
```
mysql -uambari -pambari
use ambari;
source /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql
```

### 6、命令行方式设置mysql数据库连接库，用于oozie和ranger连接mariadb时使用（上面设置后不起作用，必须如下操作）：
```
ambari-server setup --jdbc-db=mysql --jdbc-driver=/usr/share/java/mysql-connector-java.jar
```

### 7、配置ambari-server自启动，启动ambari-server

```
[root@ep-bd01 downloads]# systemctl enable ambari-server
[root@ep-bd01 downloads]# systemctl start ambari-server
[root@ep-bd01 downloads]# systemctl status ambari-server
● ambari-server.service - LSB: ambari-server daemon
   Loaded: loaded (/etc/rc.d/init.d/ambari-server; bad; vendor preset: disabled)
   Active: active (running) since Tue 2018-08-14 11:06:16 CST; 2min 36s ago
     Docs: man:systemd-sysv-generator(8)
  Process: 323056 ExecStart=/etc/rc.d/init.d/ambari-server start (code=exited, status=0/SUCCESS)
   CGroup: /system.slice/ambari-server.service
           └─323080 /usr/java/jdk1.8.0_181-amd64/bin/java -server -XX:NewRatio=3 -XX:+UseConcMarkSweepGC -XX:-UseGCOverheadLimit -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -Dsun.zip.disableMemoryMapping=true -...

Aug 14 11:05:58 ep-bd01 ambari-server[323056]: Organizing resource files at /var/lib/ambari-server/resources...
Aug 14 11:05:58 ep-bd01 ambari-server[323056]: Ambari database consistency check started...
Aug 14 11:05:58 ep-bd01 ambari-server[323056]: Server PID at: /var/run/ambari-server/ambari-server.pid
Aug 14 11:05:58 ep-bd01 ambari-server[323056]: Server out at: /var/log/ambari-server/ambari-server.out
Aug 14 11:05:58 ep-bd01 ambari-server[323056]: Server log at: /var/log/ambari-server/ambari-server.log
Aug 14 11:06:16 ep-bd01 ambari-server[323056]: Waiting for server start.....................
Aug 14 11:06:16 ep-bd01 ambari-server[323056]: Server started listening on 8080
Aug 14 11:06:16 ep-bd01 ambari-server[323056]: DB configs consistency check: no errors and warnings were found.
Aug 14 11:06:16 ep-bd01 ambari-server[323056]: Ambari Server 'start' completed successfully.
Aug 14 11:06:16 ep-bd01 systemd[1]: Started LSB: ambari-server daemon.systemctl status ambari-server
● ambari-server.service - LSB: ambari-server daemon
   Loaded: loaded (/etc/rc.d/init.d/ambari-server; bad; vendor preset: disabled)
   Active: active (running) since Tue 2018-08-14 11:06:16 CST; 2min 36s ago
     Docs: man:systemd-sysv-generator(8)
  Process: 323056 ExecStart=/etc/rc.d/init.d/ambari-server start (code=exited, status=0/SUCCESS)
   CGroup: /system.slice/ambari-server.service
           └─323080 /usr/java/jdk1.8.0_181-amd64/bin/java -server -XX:NewRatio=3 -XX:+UseConcMarkSweepGC -XX:-UseGCOverheadLimit -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -Dsun.zip.disableMemoryMapping=true -...

Aug 14 11:05:58 ep-bd01 ambari-server[323056]: Organizing resource files at /var/lib/ambari-server/resources...
Aug 14 11:05:58 ep-bd01 ambari-server[323056]: Ambari database consistency check started...
Aug 14 11:05:58 ep-bd01 ambari-server[323056]: Server PID at: /var/run/ambari-server/ambari-server.pid
Aug 14 11:05:58 ep-bd01 ambari-server[323056]: Server out at: /var/log/ambari-server/ambari-server.out
Aug 14 11:05:58 ep-bd01 ambari-server[323056]: Server log at: /var/log/ambari-server/ambari-server.log
Aug 14 11:06:16 ep-bd01 ambari-server[323056]: Waiting for server start.....................
Aug 14 11:06:16 ep-bd01 ambari-server[323056]: Server started listening on 8080
Aug 14 11:06:16 ep-bd01 ambari-server[323056]: DB configs consistency check: no errors and warnings were found.
Aug 14 11:06:16 ep-bd01 ambari-server[323056]: Ambari Server 'start' completed successfully.
Aug 14 11:06:16 ep-bd01 systemd[1]: Started LSB: ambari-server daemon.
```

### 8、Ambari-server安装完成。浏览器访问ambari-server服务：

http://192.168.74.3:8080

默认用户名/密码为：admin/admin

通过web页面安装ambari-agent。


## 三、报错处理

1、通过web页面安装集群，confirm hosts 这里安装ambari-agent失败

先登录各节点主机执行 yum remove ambari-agent，后systemctl daemon-reload；如果还是失败，tail -f /var/log/ambari-server/ambari-server.log 查看日志，很有可能是/etc/yum.repo.d目录下多出了 ambari-hdp-1.repo、 ambari-hdp-2.repo这两个文件，删掉，只保留ambari.repo这个文件 

2、重装ambari-server，需要先做的动作

（1）yum remove ambari-server 

（2）删除mysql中的ambari库，重新建库ambari

3、日志位置： /var/log/ambari-server/ 、 /var/run/ambari-server 、 /var/run/ambari-agent

4、通过web页面安装集群，上传私钥这里，不要复制，将ambari-server所在服务器`~/.ssh/id_rsa`文件下载后使用上传文件的方式上传，这一页的添加集群包含的服务器这里，需要填写服务器的FQDN，如 `master.ambari.com`，一台服务器一行。

如果上传私钥后，后续操作报错，日志还是显示公钥认证报错：`Permission denied (publickey,gssapi-keyex,gssapi-with-mic)`，使用`ssh-keygen -t dsa`的方式替代rsa的方式生成密钥。
 
5、第一次安装集群失败后，再次安装，可能报错：`[ambari-action-scheduler] ExecutionCommandWrapper:219 - Unable to lookup the cluster by ID; assuming that there is no cluster and therefore no configs for this execution command: Cluster not found, clusterName=clusterID=-1`

换个集群名字，再次安装时的集群名需要与第一次安装时不同。 


