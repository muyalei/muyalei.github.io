---
layout: default
author: muyalei
title: 反爬策略之字体反爬
date: 2021-01-06
tags:
    - 爬虫相关
---


***鄙人原创，转载请注明出处***


*** 参考：***

[https://blog.csdn.net/m0_49077792/article/details/111369149](https://blog.csdn.net/m0_49077792/article/details/111369149)</p>
[https://www.downdawn.com/blog/detail/33/](https://www.downdawn.com/blog/detail/33/)</p>
[https://zhuanlan.zhihu.com/p/99497149](https://zhuanlan.zhihu.com/p/99497149)</p>
[https://www.cnblogs.com/xuchunlin/p/11427959.html](https://www.cnblogs.com/xuchunlin/p/11427959.html)</p>

## 简介

大众点评网站使用的反爬策略包括封cookie、封ua、封IP、滑块验证条、图片验证码、字体反爬，字体反爬策略又分为字体库反爬、css映射文件反爬，大众点评都有使用。

***字体库反爬处理思路：***

（1）找到字体文件--woff或ttf，使用python第三方模块footTools将字体文件解析为xml，从中按序提取字体文件对应的编码</p>
（2）按序读取woff或ttf字体文件中的字符。一般来说，字体文件库中的字符及其顺序不会改变，一次读取后续复用即可，如果遇上随机变动的，需要借助ocr，参考：（url忘了）</p>
（3）将编码、字符组成dict，将抓取到页面中加密字符还原。</p>

***css字体文件反爬思路：***

（1）点击`Elements`分析面板上加密字符，右侧出现该加密字符对应css字体文件url，这个css文件中可能有多个.svg文件，对应着每个class类型的坐标与字符映射关系</p>
（2）查看字宽，找规律，点评有3种映射关系，大同小异，一般横纵坐标中，一个坐标除以字宽得到的是这个字符在svg文件中所在行的索引值，另一个坐标除以字宽是这个字符在svg文件中所在行</p>
（3）解析各个class类的映射文件，组成dict，将抓取页面中加密字符还原</p>

## 详细步骤

### 字体库反爬

如上图，可以看到评论信息中有的字符不能正常显示

```
#处理字体库反爬
    def parse_ziti(self):
        #随便请求一个门店，获取包含字体文件链接的css文件的链接
        ziti_url = ''
        self.headers['Cookie'] = self.get_cookies() #使用随机生成的cookie
        url = 'http://www.dianping.com/shop/G4bGgYIA6oPgB8kF' #随便一个门店的详情页url都可以
        resp = requests.get(url,headers=self.headers,timeout=30,allow_redirects=False)
        if resp.status_code==200:
            bsobj = BeautifulSoup(resp.text,'lxml')
            items = bsobj.findAll('link',{'type':'text/css'})
            for item in items:
                if 's3plus.meituan.net' in item.attrs.get('href',''):
                    ziti_url = item.attrs['href'] #css字体文件url
                    break
        elif resp.status_code==302:
            print('出现验证码')
            resp = requests.get(url,headers=self.headers,timeout=30)
            print(resp.url)
            time.sleep(60)
        else:
            print('响应异常！！60s后重试')
            self.parse_ziti()
        #确认提取到了css文件的url
        if not ziti_url:
            self.parse_ziti()
        #请求css文件，获取所有字体文件的url
        self.headers['Cookie'] = self.get_cookies()
        resp = requests.get(url='http:'+ziti_url,headers=self.headers,timeout=30,allow_redirects=False)
        if resp.status_code==200:
            items = re.findall('@font-face{font-family: "PingFangSC-Regular-(.*?)";src:url\(".*?format\(.*?,url\("(.*?)"\);}',resp.text,re.S)
            for item in items:
                file_name = item[0]
                ziti_url = 'http:'+item[1]
                r = requests.get(ziti_url,headers=self.headers)
                with open('字体文件/'+file_name+'.woff','wb') as f:
                    f.write(r.content)
                    f.close()
        #解析字体文件，生成字典
        words = '1234567890店中美家馆小车大市公酒行国品发电金心业商司超生装园场食有新限天面工服海华水房饰城乐汽香部利子老艺花专东肉菜学福饭人百餐茶务通味所山区门药银农龙停尚安广鑫一容动南具源兴鲜记时机烤文康信果阳理锅宝达地儿衣特产西批坊州牛佳化五米修爱北养卖建材三会鸡室红站德王光名丽油院堂烧江社合星货型村自科快便日民营和活童明器烟育宾精屋经居庄石顺林尔县手厅销用好客火雅盛体旅之鞋辣作粉包楼校鱼平彩上吧保永万物教吃设医正造丰健点汤网庆技斯洗料配汇木缘加麻联卫川泰色世方寓风幼羊烫来高厂兰阿贝皮全女拉成云维贸道术运都口博河瑞宏京际路祥青镇厨培力惠连马鸿钢训影甲助窗布富牌头四多妆吉苑沙恒隆春干饼氏里二管诚制售嘉长轩杂副清计黄讯太鸭号街交与叉附近层旁对巷栋环省桥湖段乡厦府铺内侧元购前幢滨处向座下臬凤港开关景泉塘放昌线湾政步宁解白田町溪十八古双胜本单同九迎第台玉锦底后七斜期武岭松角纪朝峰六振珠局岗洲横边济井办汉代临弄团外塔杨铁浦字年岛陵原梅进荣友虹央桂沿事津凯莲丁秀柳集紫旗张谷的是不了很还个也这我就在以可到错没去过感次要比觉看得说常真们但最喜哈么别位能较境非为欢然他挺着价那意种想出员两推做排实分间甜度起满给热完格荐喝等其再几只现朋候样直而买于般豆量选奶打每评少算又因情找些份置适什蛋师气你姐棒试总定啊足级整带虾如态且尝主话强当更板知己无酸让入啦式笑赞片酱差像提队走嫩才刚午接重串回晚微周值费性桌拍跟块调糕'
        address_glyList = TTFont('字体文件/address.woff').getGlyphOrder()[2:] #address、num用了同一套编码
        hours_glyList = TTFont('字体文件/hours.woff').getGlyphOrder()[2:]
        review_glyList = TTFont('字体文件/review.woff').getGlyphOrder()[2:]
        shopdesc_glyList = TTFont('字体文件/shopdesc.woff').getGlyphOrder()[2:]
        address_ziti_dict = dict(zip(address_glyList,words))
        hours_ziti_dict = dict(zip(hours_glyList,words))
        review_ziti_dict = dict(zip(review_glyList,words))
        shopdesc_ziti_dict = dict(zip(shopdesc_glyList,words))
        print(review_ziti_dict)
    

    #处理css映射字体反爬（全部评论页面）
    def get_zitiFile(self):
        #获取css字体映射文件链接
        self.headers['Cookie'] = self.get_cookies()  #使用随机生成的cookie
        url = 'http://www.dianping.com/shop/G4wbbRRWVWqvbKCh/review_all' #随便一个门店的详情页url都可以
        resp = requests.get(url,headers=self.headers,timeout=30,allow_redirects=False)
        if resp.status_code==200:
            css_url = 'http://s3plus.meituan.net'+re.search('//s3plus\.meituan\.net(.*?)\.css',resp.text,re.S).group(1)+'.css'
            print(css_url)
            #请求css字体映射文件
            resp2 = requests.get(url=css_url,headers=self.headers,timeout=30,allow_redirects=False)
            if resp2.status_code==200:
                cssMapping = resp2.text  #css字体映射文件的内容
                addrSvg_url = 'http:'+re.search('bb\[class.*?background-image: url\((.*?)\);',resp2.text,re.S).group(1) #地址svg文件地址
                telSvg_url = 'http:'+re.search('cc\[class.*?background-image: url\((.*?)\);',resp2.text,re.S).group(1) #电话svg文件地址
                reviewSvg_url = 'http:'+re.search('svgmtsi\[class.*?background-image: url\((.*?)\);',resp2.text,re.S).group(1) #评论svg文件地址
                print(addrSvg_url,telSvg_url,reviewSvg_url)
                #解析字体文件
                self.parse_ziti(cssMapping,addrSvg_url,telSvg_url,reviewSvg_url)
            else:
                print('请求svg文件链接响应异常！！响应码：%s，允许自动重定向后请求地址为：\n%s' % (resp2.status_code,requests.get(url=css_url,headers=self.headers,timeout=30).url))
        else:
            print('请求css字体映射文件链接响应异常！！响应码：%s，允许自动重定向后的请求地址为：\n%s' % (resp.status_code,requests.get(url,headers=self.headers,timeout=30).url))


    def parse_ziti(self,cssMapping,addrSvg_url,telSvg_url,reviewSvg_url):
        ##解析地址字体文件
        #从css文件抽取所有地址加密字符串
        addr_cssMapping = re.findall('\.ld(.*?){background:-(.*?)\.0px -(.*?)\.0px;}',cssMapping,re.S)
        addr_cssMapping_1 = dict()
        for item in addr_cssMapping:
            string = 'ld'+item[0] #地址加密字符在html中对应的code
            index1 = int(item[1])/14 #行内索引
            index2 = item[2] #所在哪一行行索引
            addr_cssMapping_1[string] = [index1,index2]
        print(addr_cssMapping_1)
        #获取地址字符加密svg文件
        resp_addrSvg = requests.get(url=addrSvg_url,headers=self.headers,timeout=30,allow_redirects=False)
        if resp_addrSvg.status_code==200:
            addrSvg = re.findall('<text x="0" y="(.*?)">(.*?)</text>',resp_addrSvg.text,re.S)
            print(addrSvg)
            #地址字体解密后结果
            addr_result = dict()
            for k,v in addr_cssMapping_1.items():
                string = k
                index1,index2 = v
                for item in addrSvg: #地址加密svg文件里本身是按照从小到大排列
                    if int(index2)<=int(item[0]):
                        text = item[1]
                        break
                addr_result[string] = text[int(index1)]
            print(addr_result)
            
        #解析电话字体文件
        #从css文件抽取所有电话加密字符串
        tel_cssMapping = re.findall('\.pu(.*?){background:-(.*?)\.0px.*?0px;}',cssMapping,re.S)
        tel_cssMapping_1 = dict()
        for item in tel_cssMapping:
            string = 'pu'+item[0] #电话加密字符在html中对应的code
            index = int(item[1])//14 #行内索引
            tel_cssMapping_1[string] = index
        print(tel_cssMapping_1)
        #获取电话字符加密svg文件
        resp_telSvg = requests.get(url=telSvg_url,headers=self.headers,timeout=30,allow_redirects=False)
        if resp_telSvg.status_code==200:
            telSvg = re.search('<text x="14 28 42 56 70 84 98 112 126 140 " y="41">(.*?)</text>',resp_telSvg.text,re.S).group(1)
            print(telSvg)
            #电话字体解密后结果
            tel_result = dict()
            for string,index in tel_cssMapping_1.items():
                tel_result[string] = telSvg[int(index)]
            print(tel_result)
        
        ##解析评论字体加密文件
        #从css文件抽取所有评论加密字符串
        review_cssMapping = re.findall('\.xo(.*?){background:-(.*?)\.0px -(.*?)\.0px;}',cssMapping,re.S)
        review_cssMapping_1 = dict()
        for item in review_cssMapping:
            string = 'xo'+item[0] #评论加密字符在html中对应的code
            index1 = int(item[1])/14 #行内索引
            index2 = item[2] #所在哪一行行索引
            review_cssMapping_1[string] = [index1,index2]
        print(review_cssMapping_1)
        #获取评论字符加密svg文件
        resp_reviewSvg = requests.get(url=reviewSvg_url,headers=self.headers,timeout=30,allow_redirects=False)
        if resp_reviewSvg.status_code==200:
            reviewSvg_path = re.findall('<path id="(.*?)" d="M0 (.*?) H600"/>',resp_reviewSvg.text,re.S)
            reviewSvg_textPath = re.findall('<textPath xlink:href="#(.*?)" textLength=".*?">(.*?)</textPath>',resp_reviewSvg.text,re.S)
            reviewSvg_textPath_dict = dict()
            for item in reviewSvg_textPath:
                reviewSvg_textPath_dict[item[0]] = item[1]
            print(reviewSvg_path)
            print(reviewSvg_textPath_dict)
            #评论信息字体解密后结果
            tel_result = dict()
            for k,v in review_cssMapping_1.items():
                string = k
                index1,index2 = v
                for item in reviewSvg_path: #评论信息加密svg文件里本身是按照从小到大排列
                    if int(index2)<=int(item[1]):
                        id = item[0]
                        break
                print(reviewSvg_textPath_dict[id][int(index1)])
                tel_result[string] = reviewSvg_textPath_dict[id][int(index1)]
            print(tel_result)
```

### css字体文件映射反爬
